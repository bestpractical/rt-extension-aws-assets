#!/usr/bin/env perl
### before: #!@PERL@

use strict;
use warnings;

package RT::AWS::Assets::Run;

BEGIN {
### after:     use lib qw(@RT_LIB_PATH@);
use lib '/opt/rt5/local/lib /opt/rt5/lib';
use RT;
}

use RT::Interface::CLI  qw(GetCurrentUser loc);

__PACKAGE__->run(@ARGV) unless caller;

sub run{
    my ($class, @args) = @_;

    my %args = $class->process_args(@args);
    require RT::Extension::AWS::Assets;

    if ( $args{insert} ) {
        my ($aws_resources, $token);

        do {
            ($aws_resources, $token) =
                RT::Extension::AWS::Assets::FetchMultipleAssetsFromAWS(
                    Region => $args{'region'},
                    ServiceType => $args{'type'},
                    ReservedInstances => $args{'reserved'},
                    Token => $token,
                    MaxResults => $args{'results'} );

                RT::Extension::AWS::Assets::InsertAWSAssets(
                    AWSResources => $aws_resources,
                    Region => $args{'region'},
                    ServiceType => $args{'type'},
                    ReservedInstances => $args{'reserved'},
                    CurrentUser => GetCurrentUser() );

        } while ( $token )
    }

    if ( $args{update} ) {
        my ($aws_resources, $token);

        do {
            ($aws_resources, $token) =
                RT::Extension::AWS::Assets::FetchMultipleAssetsFromAWS(
                    Region => $args{'region'},
                    ServiceType => $args{'type'},
                    ReservedInstances => $args{'reserved'},
                    Token => $token,
                    MaxResults => $args{'results'} );

                RT::Extension::AWS::Assets::UpdateAWSAssets(
                    AWSResources => $aws_resources,
                    Region => $args{'region'},
                    ServiceType => $args{'type'},
                    ReservedInstances => $args{'reserved'},
                    CurrentUser => GetCurrentUser() );

        } while ( $token )
    }

    return;
}

sub process_args {
    require Getopt::Long;
    local @ARGV = @_;

    my %opt;
    RT::Interface::CLI::Init( \%opt, 'help|h', 'insert|i', 'update|u', 'catalog=s', 'type=s', 'reserved', 'region=s', 'results=i', 'debug|d' );

    if ( delete $opt{help} ) {
        require Pod::Usage;
        Pod::Usage::pod2usage( { verbose => 2 } );
        exit;
    }

    if ( $opt{'insert'} && $opt{'update'} ) {
        print "Running insert and update at the same time is not supported, exiting.\n";
        exit;
    }

    unless ( $opt{'results'} ) {
        $opt{'results'} = 20;
    }

    return %opt;
}

1;

__END__

=head1 NAME

rt-import-aws-assets - import asset data from AWS

=head1 SYNOPSIS

    rt-import-aws-assets

=head1 DESCRIPTION

Access your AWS account using the aws-cli utility to pull in data and
add it to RT assets.

